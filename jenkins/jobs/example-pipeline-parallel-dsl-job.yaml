---
- job:
    name: atom-swarm-tests
    description: |
        Atom daily swarm tests.

        aws - 3 nodes with "remote" option 
        kvm - 3 nodes then adding one extra 
        vmware - 3 nodes
        quickstart-aws - build/deploy
        quickstart-kvm - build/deploy
        quickstart-vbox - build/deploy
         

    triggers:
      - timed: 'H 20 * * *'
    project-type: pipeline
    dsl: |
        i = 0
        jobs_sum = 6
        slack_channel = '#atom-infra-team'
        parallel (
            "aws" : { try { stage('aws') { build 'atom-swarm-test-aws'} } catch(err) { ++i } },
            "kvm" : { try { stage('kvm') { build 'atom-swarm-test-kvm'} } catch(err) { ++i } },
            "vmware" : { try { stage('vmware') { build 'atom-swarm-test-vmware' } } catch(err) { ++i } },
            "quickstart-aws" : { try { stage('quickstart-aws') { build 'atom-quickstart-build-image-aws' } } catch(err) { ++i } },
            "quickstart-vbox" : { try { stage('quickstart-vbox') { build 'atom-quickstart-build-image-vbox' } } catch(err) { ++i } }
        )
        try { stage('quickstart-kvm') { build 'atom-quickstart-build-image-kvm' } } catch(err) { ++i }
        s = jobs_sum - i
        if ( i == jobs_sum ) { currentBuild.result = 'FAILED'
                slackSend channel: "${slack_channel}",
                    color: '#FF0000',
                    message: "*${currentBuild.currentResult}:* ${env.JOB_NAME}: All jobs failed.\n More info at: ${env.JOB_URL}"
        }
        if ( i > 0 && i < jobs_sum ){ currentBuild.result = 'UNSTABLE'
                slackSend channel: "${slack_channel}",
                    color: '#FFFF00',
                    message: "*${currentBuild.currentResult}:* ${env.JOB_NAME} - ${s} job(s) passed. ${i} job(s) failed.\n More info at: ${env.JOB_URL}"
        }
        if ( currentBuild.currentResult == 'SUCCESS' ){
                slackSend channel: "${slack_channel}",
                   color: 'good',
                   message: "*${currentBuild.currentResult}:* ${env.JOB_NAME} - All jobs passed.\n More info at: ${env.JOB_URL}"
        }
